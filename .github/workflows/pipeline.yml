name: CI/CD

on:
    push:
        branches: [ main ]

env:
    REGISTRY: ghcr.io
    REPOSITORY: ${{github.repository}}

jobs:
    test:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
        - name: Fetch code
          uses: actions/checkout@v4.2.2

        - name: Install Node 20
          uses: actions/setup-node@v4.1.0
          with:
                node-version: '20'

        - name: Start PostgreSQL
          run: |
            sudo systemctl start postgresql
            sudo systemctl enable postgresql

        - name: Setup PostgreSQL
          run: |
            sudo -u postgres psql -c "SELECT version();"
            sudo -u postgres psql -c "CREATE DATABASE test_db;"
            sudo -u postgres psql -c "CREATE USER root WITH PASSWORD 'password';"
            sudo -u postgres psql -c "ALTER ROLE root SUPERUSER;"
            sudo -u postgres psql -c "\l"

        - name: Seed Database
          working-directory: ./db
          run: PGPASSWORD=password psql -h localhost -U root -d test_db -f init.sql

        - name: Create backend testing env file
          run: |
            echo '${{ secrets.ENV_FILE_TEST }}' > ./backend/.env

        - name: Install the backend dependencies
          working-directory: ./backend
          run: npm install

        - name: Build backend code
          working-directory: ./backend
          run: npm run build

        - name: Typecheck the backend
          working-directory: ./backend
          run: npm run typecheck

        - name: Run the backend tests
          working-directory: ./backend
          run: npm run test

        - name: Install the frontend dependencies
          working-directory: ./frontend
          run: npm install

        - name: Build frontend code
          working-directory: ./frontend
          run: npm run build

    deploy:
        name: Server Deployment
        needs: test
        runs-on: ubuntu-latest
        steps:
          - name: Fetch Code
            uses: actions/checkout@v4

          - name: Deploy backend to Render
            run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}

          - name: Deploy frontend to Render
            run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
